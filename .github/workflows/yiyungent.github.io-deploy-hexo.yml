name: yiyungent.github.io - Build and Deploy Hexo

on:
  workflow_dispatch: # Run workflow manually (without waiting for the cron to be called), through the Github Actions Workflow page directly
  # schedule: # Run workflow automatically
    # - cron: "0 * * * *" # æ¯ 1 h è¿è¡Œä¸€æ¬¡

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@master
      with:
        # Repository name with owner. For example, actions/checkout
        # Default: ${{ github.repository }}
        repository: 'yiyungent/yiyungent.github.io'
        # The branch, tag or SHA to checkout. When checking out the repository that
        # triggered a workflow, this defaults to the reference or SHA for that event.
        # Otherwise, uses the default branch.
        ref: 'master'
        # Personal access token (PAT) used to fetch the repository. The PAT is configured
        # with the local git config, which enables your scripts to run authenticated git
        # commands. The post-job step removes the PAT.
        #
        # We recommend using a service account with the least permissions necessary. Also
        # when generating a new PAT, select the least scopes necessary.
        #
        # [Learn more about creating and using encrypted secrets](https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets)
        #
        # Default: ${{ github.token }}
        token: ${{ secrets.MY_GITHUB_TOKEN_ACTIONS }}
        # ä¸ºäº†è®© git æœ‰æ—¥å¿— (git log) å¯å¯»ï¼Œè¿˜å¾—åœ¨æ£€å‡ºçš„æ—¶å€™é¡ºå¸¦æŠŠæ‰€æœ‰æäº¤å†å²ä¸€å¹¶æ‹‰ä¸‹æ¥ï¼ŒæŒ‡å®š fetch-depth å°±èƒ½åšåˆ°
        fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod
        # submodules: true  # Fetch submodules (true OR recursive)

    - name: TimeZone
      run: |
        echo "Before:"
        date --iso-8601=seconds
        ls -l /etc/localtime
        # Setting TimeZone
        sudo rm -f /etc/localtime
        sudo ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        echo "After:"
        ls -l /etc/localtime
        date --iso-8601=seconds
      shell: bash

    - name: Setup Python 3
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install pyimaging
      run: |
        pip install pyimaging
        pyimaging --help
      shell: bash

    - name: Copyright Add watermark to images
      run: |
        pyimaging watermark --imagedir "./source/_posts" --mark "yiyun" --space 200 --color "#b7ffab" --opacity 0.3 --size 20 --quality 80
        pyimaging blind-watermark --imagedir "./source/_posts" --mark-text "Powered by yiyun"
      shell: bash

    - name: Fix File Modify Date
      # run: |
          # å®æµ‹: æ— æ•ˆ
      #   git ls-files | while read filepath; do touch -d "$(git log -1 --format='@%ct' $filepath)" "$filepath" && echo "Fixed: $filepath"; done
      # shell: bash
      run: |
        ./fix-date.ps1
        ./updated.ps1
      shell: pwsh

    - name: Use Node.js 18
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Pandoc
      run: |
        sudo apt-get install pandoc
        
    - name: Install Packages ğŸ”§ 
      run: |
        npm install -g hexo-cli
        # npm install
        # ä½¿ç”¨ npm ci é”å®šç‰ˆæœ¬, ç¡®ä¿ CI/CD ç¯å¢ƒä¸å¼€å‘ç¯å¢ƒä¸€è‡´, åŒæ—¶ç¡®ä¿ä¸ä¼šå‡ºç° prompt
        npm ci
      shell: bash

    - name: Fix NexT sidebar
      id: fix-next-sidebar
      run: |
        # fixed: ä½¿ç”¨ hexo-blog-encrypt åŠ å¯†å, å¯¼è‡´ NexT ä¾§è¾¹ç›®å½•ä¸æ˜¾ç¤º
        cat './node_modules/hexo-theme-next/layout/_macro/sidebar.njk' | sed 's/toc(page.content/toc(page.origin/g' | tee './node_modules/hexo-theme-next/layout/_macro/sidebar.njk'
        CON=$(cat './node_modules/hexo-theme-next/layout/_macro/sidebar.njk')
        # è·å–å­—ç¬¦ä¸²é•¿åº¦
        CON=${#CON}
        echo "CON: ${CON}"
        echo "conclusion=${CON}" >> $GITHUB_OUTPUT
      shell: bash

    - name: æ›¿æ¢ Markdown ä¸­ æ¢è¡Œç¬¦
      run: |
        ./æ›¿æ¢æ¢è¡Œç¬¦.ps1
      shell: pwsh

    - name: Build ğŸ”§ 
      run: |
        hexo clean
        # è§£å†³ Hexo æ–‡ç« æ—¶é—´ä¸º UTC+0, è€Œä¸æ˜¯ UTC+08:00
        export TZ='Asia/Shanghai'
        hexo generate

    - name: Copy the pre-encrypted files to public-temp
      run: |
        #mkdir public-temp # æ³¨æ„: public-temp ç›®å½•ä¸èƒ½å·²å­˜åœ¨, å¦åˆ™ä¼šå¯¼è‡´ public æ–‡ä»¶å¤¹å¤åˆ¶è¿› public-temp æ–‡ä»¶å¤¹å†…, ä¸ç¬¦åˆè¦æ±‚
        cp -r public public-temp
      shell: bash

    - name: Hexo Encrypt
      run: |
        $hexoPassword="${{ secrets.HEXO_PASSWORD }}"
        ./password.ps1
      shell: pwsh

    - name: Build ğŸ”§ 
      id: build-2
      run: |
        hexo clean
        # è§£å†³ Hexo æ–‡ç« æ—¶é—´ä¸º UTC+0, è€Œä¸æ˜¯ UTC+08:00
        export TZ='Asia/Shanghai'
        hexo generate
        # æµ‹è¯•: é¦–é¡µæ˜¯å¦ç”ŸæˆæˆåŠŸ
        CON=$(cat './public/index.html')
        # è·å–å­—ç¬¦ä¸²é•¿åº¦
        CON=${#CON}
        echo "CON: ${CON}"
        echo "conclusion=${CON}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Copy the file before encryption and overwrite the file after encryption
      run: |
        #cp -f public-temp/search.xml  public/search.xml
        cp -f public-temp/search.json  public/search.json
        cp -f public-temp/atom.xml  public/atom.xml
        cp -f public-temp/content.json  public/content.json
      shell: bash
    
    - name: Send Email
      if: ${{ steps.fix-next-sidebar.outputs.conclusion <= 100 || steps.build-2.outputs.conclusion <= 100 }}
      env:
        USER_EMAIL: ${{ secrets.USER_EMAIL }}
        USER_EMAIL_PASSWORD: ${{ secrets.USER_EMAIL_PASSWORD }}
      run: |
        python email_sending.py
      shell: bash

    - name: Deploy ğŸš€
      id: deploy
      # æ­¤ç§è¯­æ³•ä¸åˆæ³• https://docs.github.com/en/actions/learn-github-actions/expressions
      # if: [ steps.fix-next-sidebar.outputs.conclusion -gt 100 ] && [ steps.build-2.outputs.conclusion -gt 100 ] 
      if: ${{ steps.fix-next-sidebar.outputs.conclusion > 100 && steps.build-2.outputs.conclusion > 100 }}
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        token: ${{ secrets.MY_GITHUB_TOKEN_ACTIONS }}
        branch: gh-pages
        folder: public
        repository-name: yiyungent/yiyungent.github.io
        git-config-name: "github-actions[bot]"
        git-config-email: "41898282+github-actions[bot]@users.noreply.github.com"

    - name: HTTP invoke deploy-github-pages.yml
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        OWNER="yiyungent" 
        REPO="yiyungent.github.io" 
        WORKFLOW_ID="deploy-github-pages.yml" 
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.MY_GITHUB_TOKEN_ACTIONS }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_ID}/dispatches \
          -d '{"ref":"master"}'
      shell: bash

    # - name: Upyun Refresh
    #   if: ${{ steps.fix-next-sidebar.outputs.conclusion > 100 && steps.build-2.outputs.conclusion > 100 }}
    #   uses: yiyungent/upyun-action@main
    #   with:
    #     # åœ¨ Settings->Secrets é…ç½® UPYUN_USERNAME, UPYUN_PASSWORD
    #     upyun_username: ${{ secrets.UPYUN_USERNAME }}
    #     upyun_password: ${{ secrets.UPYUN_PASSWORD }}
    #     # è¦åˆ·æ–°çš„url, æ”¯æŒåŒ¹é…ç¬¦ *, å¤šä¸ªurlä¸­é—´ç”¨ \n éš”å¼€
    #     refresh_cache_urls: "https://moeci.com/*\nhttps://moeci.com"
    #     upyun_debug: true

